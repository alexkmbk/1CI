#1CI
Система автоматизации работы с конфигурацией подключенной к хранилищу.

# Задача

В ходе коллективной разработки, приходится выполнять ряд рутинных
операций, которые можно было бы автоматизировать, как например:

-   Ежедневная выгрузка и отправка партнерам актуальной версии
    конфигурации из хранилища;
-   Проведение различных тестов конфигурации перед отправкой, например
    проверка конфигурации встроенными в платформу механизмами или с
    помощью специальных тестовых обработок\\конфигураций.
-   Уведомление участников проекта о найденных ошибках в ходе
    тестирования по средством эл. почты или интернет мессенджеров
    (Skype, Telegram).
-   Загрузка конфигурации в рабочую базу данных.

Для автоматизации подобных задач и предназначена конфигурация 1CI. Часть
названия конфигурации является аббревиатурой и расшифровывающейся как
Continuous Integration, что является отсылкой к одноименной концепции.

# Общее описание конфигурации.

Конфигурация: самостоятельная, без необходимости встраивания;

Платформа: 8.3 (без режима совместимости);

Интерфейс: Такси;

БСП: 2.2.4.4 (Английская версия);

Язык разработки: Английский;

Режим: Асинхронный.

Функционал конфигурации строится вокруг справочника «Repositories»,
каждый элемент которого соответствует отдельному хранилищу конфигурации,
в котором ведется разработка. Для каждого элемента справочника задается
список пользователей, которые могут работать с хранилищем, их имена и
пароли.

В справочнике «Tasks», подчиненном справочнику «Repositories» задается
перечень задач которые необходимо автоматизировать. Каждая задача может
быть запущена на выполнение несколькими разными методами:

-   В ручную из клиента 1С: Предприятие;
-   По расписанию, с помощью регламентного задания;
-   Из командной строки 1С: Предприятия;
-   HTTP запросом;
-	С помощью внешнего соединения (COM коннектор).

Для элементов справочника «Tasks», в табличной части, задается список
действий, которые необходимо выполнить. Действия выполняются
последовательно, в соответствии с номером строки табличной части.

Каждое действие, это элемент справочника «Actions», в котором хранится
ссылка на обработку, в которой и прописан алгоритм выполняемого
действия. Обработка может быть внешней, тогда, на неё сохраняется
ссылка из справочника «AdditionalReportsAndDataProcessors», являющегося
частью подсистемы «AdditionalReportsAndDataProcessors» из БСП. Обработка
может быть также внутренней, тогда, в справочнике «Actions» хранится
наименование обработки из дерева объектов конфигурации.

![alt tag](https://github.com/alexkmbk/1CI/blob/master/Description/TasksDiagram.png)

Во время выполнения задачи, в памяти создается список доступных общих
параметров, которые могут быть использованы обработками при выполнении
различных операций. Список параметров существует и актуален только во
время выполнения конкретной задачи. Одним из важных параметров,
является путь к файлу выгрузки конфигурации из хранилища. Сам путь и имя
файла выгрузки формируется еще до выполнения действий и передается в
обработку перед выполнением, поэтому, если скажем есть обработка,
которая должна выгрузить конфигурацию из хранилища и обработка которая
затем должна эту конфигурацию протестировать, то первой в списке
действий должна идти обработка которая выгружает конфигурацию. Ей будет
передан путь к файлу выгрузки (хотя самого файла на диске еще нет) и
она, по указанному пути и имени, сохраняет конфигурацию. Все последующие
обработки будут использовать эту выгрузку, поскольку они выполняются
позже и им всем доступен путь к выгруженному файлу.

Информация о выполненных задачах и ходе их выполнения записывается в
базу данных. Каждое действие записывается независимо от других, поэтому
при резком «падении» программы, всегда можно видеть на каком этапе
процесс был остановлен.

В конфигурации предусмотрен механизм оповещения пользователей о
результатах выполнения задач. Отчет о выполненной или завершенной с
ошибкой задачи отправляется по электронной почте или
интернет-мессенджеру указанным в задаче получателям, при этом задается
два разных списка получателей: один список для случая, если задача
завершена с ошибкой, другой, если задача выполнена успешно. Поскольку
нет нужды уведомлять всех пользователей об успешном выполнении задачи,
эту информацию может получать только ответственное лицо, например
руководитель проекта.

Для каждой обработки, могут быть заданы индивидуальные параметры,
которые сохраняются в табличной части «Actions» справочника «Tasks».
Перечень параметров индивидуален для каждой обработки, форма их
редактирования реализуется самой обработкой.

Для отправки отчетов по электронной почте, используется подсистема
«EmailAccounts» из БСП.

Тестирование как и все прочие действия, выполняется с помощью обработок,
привязанных к элементам справочника «Actions». Количество всевозможных
тестов ничем не ограничено, в ходе использования конфигурации могут быть
написаны специальные тестовые обработки для определенных целей
тестирования. Это уже будет зависеть от потребностей в тестировании и от
конкретной, разрабатываемой конфигурации. В составе конфигурации
предполагается наличие нескольких встроенных, универсальных обработок
для тестирования:

- Запуск встроенного в платформу механизма тестирования
(параметр запуска ****CheckModules****);

- Выполнение тестовых сценариев нового механизма тестирвоания в платформе 8.3;

- Перепроведение списка документов конфигурации;

- Формирование списка отчетов конфигурации.

# Детальное описание объектов метаданных (из того, что уже реализовано)

Справочник «Repositories»
=========================

**Реквизиты:**

Path &lt;Строка&gt;— путь к каталогу хранилища;

WorkingDir &lt;Строка&gt; - путь к каталогу, где будут хранится файлы,
предназначенные для работы конфигурации с репозиторием, например каталог
временной базы данных, которая будет подключена к хранилищу. Если не
задан, используется каталог временных файлов.

PlatformPath &lt;Строка&gt; - путь к исполняемому файлу платформы, если
не задан, устанавливается автоматически с помощью функции «BinDir()».

DBDir &lt;Строка&gt; - путь к каталогу, где находится база данных,
подключенная к хранилищу, если не задан, то используется путь
«WorkingDir\\DB\\».

ConfBackupDir &lt;Строка&gt; - путь к каталогу, в котором должны
хранится файлы выгрузки из хранилища конфигурации, если не задан,
используется путь WorkingDir\\Backup.

ScheduledJobUser &lt;СправочникСсылка.Users&gt; - пользователь под
которым будет выполняться задача по регламентному заданию

TestDBDir &lt;String&gt; - путь к каталогу с тестовой базой данных.

TestDBAdminName &lt;String&gt; - имя пользователя, являющимся администратором тестовой базы данных.

TestDBAdminPassword &lt;String&gt; - пароль пользователя, являющимся администратором тестовой базы данных.

Справочник «Actions»
====================

**Реквизиты:**

IsInternal &lt;Булево&gt; - определяет то, является ли обработка
внутренней.

InternalDataProcessor &lt;Строка&gt; - наименование внутренней
обработки.

DataProcessor
&lt;СправочникСсылка.AdditionalReportsAndDataProcessors&gt; - ссылка на
элемент справочника с внешними обработками.

Справочник «Tasks»
==================

**Реквизиты:**

ScheduledJobGUID &lt;UUID&gt; - идентификатор регламентного задания.

RunBySchedule&lt;Булево&gt; - определяет то, следует ли выполнять задачу
по расписанию.

**Табличные части:**

Actions, реквизиты:

Action &lt;СправочникСсылка.Actions&gt;.

ActionParams &lt;Строка неограниченной длинны&gt; - Строка параметров
обработки (если таковые имеются). Строка содержит в себе структуру и
генерируется с помощью функции ЗначениеВСтрокуВнутр.

UUID – Уникальный идентификатор параметров действия.

FailureReportRecipients, реквизиты:

Email &lt;Строка&gt;.

SuccessReportRecipients, реквизиты:

Email &lt;Строка&gt;.

Документ «TaskRunningEvent»
===========================

Документ предназначен для журналирования событий выполнения задач.
Каждый отдельный документ это отдельная попытка выполнения одной задачи.

**Реквизиты:**

State &lt;Перечисление.TaskState&gt;- состояние процесса выполнения
задачи.

Task &lt;СправочникСсылка.Tasks&gt; - ссылка на задачу.

Repository &lt;СправочникСсылка.Repositories&gt; - ссылка на справочник
«Repositories». Этот реквизит добавлен для оптимизации работы механима
ограничение доступа к хранилищам на уровне записей (RLS).

Документ не делает движений, при начале выполнения задачи, система
создает и записывает этот документ с состоянием «Started». По ходу
выполнения действия, информация записывается в регистр «ActionEventsLog»
(о нем далее) где одним из измерений является ссылка на документ
TaskRunningEvent, однако регистр и документ не связаны механизмом
проведения, для записи событий проведение не используется.

Если все действия были выполнены , значение реквизита State изменяется
на «Success» или «Error» в зависимости от успеха\\неудачи выполнения.

Регистр сведений «ActionEventsLog»
==================================

Регистр предназначен для записи событий возникающих при выполнении
отдельных действий задач. Одно действие может генерировать несколько
событий.

**Периодичность:** Нет.

**Подчинение регистратору:** Нет.

**Измерения:**

TaskRunningEvent &lt;ДокументСсылка.TaskRunningEvent&gt;.

LineNum &lt;Число 9,0&gt; - порядковый номер события, нумерация ведется
в пределах одной задачи.

**Ресурсы:**

Action &lt;СправочникСсылка.Actions&gt; - действие при выполнении
которого, произошло событие.

State &lt;ПеречислениеСсылка.ActionEventTypes&gt; - Тип события
(Start,Error,DetailedInfo,Success);

Description &lt;Строка&gt; - текстовое описание событие.

Date &lt;DateTime&gt; - дата и время возникновения события.

Регистр не сделан периодическим потому что, записи чаще будут отбираться
не по периоду, а по значению ссылки на документ TaskRunningEvent.
Поэтому ссылка должна идти на первом месте в составном индексе.

Регистр сведений «RepUsers»
===========================

Регистр предназначен для хранения списка пользователей, которым
разрешено работать с данным хранилищем. Для хранилища должен быть задан
хотя бы один пользователь.

**Периодичность:** Нет.

**Подчинение регистратору:** Нет.

**Измерения:**

User &lt;СправочникСсылка.Users&gt; - ссылка на справочник Users из
подсистемы Users БСП.

Repository &lt;СправочникСсылка.Repositories&gt; - хранилище для
которого задаются пользователи в регистре.

**Ресурсы:**

RepUserName &lt;Строка&gt; - имя пользователя хранилища.

RepPassword &lt;Строка&gt; - пароль пользователя в хранилище;

Обработка «StartPage»
=====================

Обработка представляет из себя рабочий стол пользователя для работы с
подсистемой «Repositories». Главное назначение — обеспечение удобного
доступа к задачам хранилища.

Обработки выполняющие действия
===========================

Обработка, предназначенная для подключения к справочнику «Actions»
должна реализовывать в модуле объекта следующие экспортные функции:

```Run(LogLineNumber, CommonParams, Action, ActionParams, ShowMessages), ```  
параметры:  

**LogLineNumber** — порядковый номер события.

**CommonParams** - структура, содержащая перечень общих параметров,
существующих во время выполнения задачи.

**Action** — ссылка на элемент справочника «Actions».

**ActionParams** — значение параметров, заданных индивидуально для данного
действия (значения сохраняются в реквизите «ActionParams» табличной
части «Actions» справочника «Tasks» ).

**StorageAddress** &lt;Булево&gt; - адрес во временном хранилище, через него, 
можно передать сообщения на вызывавший задание клиент. 
Остается пустым в неинтерактивном режиме запуска.

```IsRepositoryDataProcessor()``` - возвращает Истина, если эта обработка
предназначена для подключения к задачам хранилища.

```IsParamsForm()``` -возвращает Истина, если обработка имеет форму настроек.

На текущий момент реализованы следующие обработки:

**DumpConfFromRepository** — предназначена для сохранения актуальной версии
конфигурации из хранилища на диск.

**SendEmail** - предназначена для отправки произвольного email сообщения
списку получателей. Список получателей и текст сообщения задается на
форме настроек обработки. Текст сообщения представляет из себя шаблон,
где в тексте можно указывать в квадратных скобках специальные параметры,
которые затем будут заполнены из общих параметров выполнения задачи,
например, параметр \[DumpConfFileFullPath\] – полный путь сохранения
файла конфигурации. Механизм заполнения шаблонов еще нуждается в
доработке.

**UpdateDB** — обновление базы данных в каталоге DBDir из репозитория.

**CheckModules** – стандартная проверка модулей конфигурации с помощью
команды CheckModules.

**UpdateTestDB** - обновляет базу данных, указанную в реквизите "TestDBDir"
справочника "Repositories". Обновление выполняет из файла выгрузки дампа
из хранилища (поэтому обработка должна запускаться после
действия DumpConfFromRepository)

**Reposting** - перепроводит все ранее проведенные документв в тестовой базе данных.

Роль «RepositoryUser»
===========================

Предоставляет доступ к объектам подсистемы «Repositories». Роль содержит
в себе основанный на RLS механизм ограничения доступа к справочнику
“Repositories” и к связанным с ним таблицам.

Заимствованные подсистемы из БСП
=============================

-   AdditionalReportsAndDataProcessors
-   BaseFunctionality
-   EmailOperations
-   Users
-   InfobaseVersionUpdate

Выполнение задач из командной строки
===============================

В общем модуле “RepTasks” присутствует функция
RunTaskByCode(КодХранилища, КодЗадачи),

где  

КодХранилища – код хранилища в справочнике, в числовом формате  
КодЗадачи – код задачи в справочник, в числовом формате.

Функция выполняет определенную переданными кодами задачу. Эту функцию
можно запустить из командной строки тем или иным способом, для примера,
можно задать специальный параметр в командной строке платформы:

run\_RepTasks.RunTaskByCode(&lt;КодХранилища&gt;,&lt;КодЗадачи&gt;)

Пример:
```
"C:\\Program Files (x86)\\1cv8\\common\\1cestart.exe" Enterprise
/F"D:\\MyDB" /N Administrator /P Password
/C"run_RepTasks.RunTaskByCode(1,2)"
```
В этом примере, будет выполнена задача под номером 2 из хранилища под
номером 1.

Выполнение задач с помощью HTTP-запроса
===================================

В конфигурации реализован HTTP-сервис с базовым URL RunTask

Выполнить задачу можно с помощью GET-запроса формата:
hs/RunTask/&lt;КодХранилища&gt;/&lt;КодЗадачи&gt;

Например, если ИБ опубликована на веб-сервере localhost под именем
OneCI, то строка http-запроса к задаче с кодом 1 к хранилищу с кодом хранилища 2
будет выглядеть следующим образом:

<http://localhost/OneCI/hs/RunTask/1/2>

Запросы необходимо выполнять используюя Basic Authentication.

Этот же запрос на языке Python 2 можно выполнить следующим образом:

```python
import urllib

import urllib2

import base64

url = "http://localhost/OneCI/hs/RunTask/1/2"

authKey = base64.b64encode("Administrator:password")

headers = {"Content-Type":"application/json", "Authorization":"Basic " +
authKey}

request = urllib2.Request(url)

for key,value in headers.items():

request.add_header(key,value)

response = urllib2.urlopen(request)

print response.getcode()
```
Здесь имя пользователя базы данных - Administrator, а пароль - password.

Выполнение задач с помощью внешнего соединения (COM-коннектора)
=========================

Общий модуль "RepTasks" доступен для внешнего соединения, поэтому возможно
вызвать метод "RunTaskByCode" с помощью COM коннектора.

Пример вызова на языке 1С: Предприятие:
```
Connector = new COMObject("V83.COMConnector");
Connection = Connector.connect("file=D:\\dev\\1c\\1CI;Usr=Administrator;");
Connection.RepTasks.RunTaskByCode(1,2);
```
здесь:  
	1 - код хранилища из справочника "Repositories"  
	2 - код задачи из справочника "Tasks"


Пример на python 2.7:

```python
import pythoncom
import win32com.client

pythoncom.CoInitialize()
V83 = win32com.client.Dispatch("V83.COMConnector").Connect("file=D:\\dev\\1c\\1CI;Usr=Administrator;")
V83.RepTasks.RunTaskByCode(1,2)
```

Для выполнения этого примера, необходимо установить модуль "pythoncom":
```pip install pypiwin32```
